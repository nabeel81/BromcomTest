<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AegisSchool MIS (Single-file)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM UMD builds -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in-browser JSX compilation (fine for demo / CodePen style) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body,#root{height:100%;} body{margin:0;}</style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Seed demo data (runs before React state initializers)
    (function seedDemo(){
      try{
        if(!localStorage.getItem('users')){
          const users = [
            {user:'admin', pass:'admin', role:'admin'},
            {user:'teacher', pass:'teacher', role:'teacher'}
          ];
          const students = [
            {id: 1, name: 'Alice', grade:2, points:0, detention:false},
            {id: 2, name: 'Bob', grade:3, points:0, detention:false},
            {id: 3, name: 'Charlie', grade:4, points:0, detention:false}
          ];
          localStorage.setItem('users', JSON.stringify(users));
          localStorage.setItem('students', JSON.stringify(students));
        }
      }catch(e){console.warn('Seed failed',e);}    
    })();

    function AegisSchoolMIS() {
      const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('users')) || []);
      const [current, setCurrent] = useState(() => JSON.parse(localStorage.getItem('current')) || null);
      const [students, setStudents] = useState(() => JSON.parse(localStorage.getItem('students')) || []);
      const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('attendance')) || {});
      const [behaviourLogs, setBehaviourLogs] = useState(() => JSON.parse(localStorage.getItem('behaviourLogs')) || []);
      const [grades, setGrades] = useState(() => JSON.parse(localStorage.getItem('grades')) || {});
      const [timetable, setTimetable] = useState(() => JSON.parse(localStorage.getItem('timetable')) || {
        Monday:{P1:'',P2:'',P3:'',P4:'',P5:''},
        Tuesday:{P1:'',P2:'',P3:'',P4:'',P5:''},
        Wednesday:{P1:'',P2:'',P3:'',P4:'',P5:''},
        Thursday:{P1:'',P2:'',P3:'',P4:'',P5:''},
        Friday:{P1:'',P2:'',P3:'',P4:'',P5:''}
      });

      const saveAll = () => {
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('current', JSON.stringify(current));
        localStorage.setItem('students', JSON.stringify(students));
        localStorage.setItem('attendance', JSON.stringify(attendance));
        localStorage.setItem('behaviourLogs', JSON.stringify(behaviourLogs));
        localStorage.setItem('grades', JSON.stringify(grades));
        localStorage.setItem('timetable', JSON.stringify(timetable));
      };

      useEffect(() => saveAll(), [users, current, students, attendance, behaviourLogs, grades, timetable]);

      const signup = (user, pass, role) => {
        if(!user || !pass) return alert('Enter username and password');
        if(users.find(u => u.user === user)) return alert('User exists');
        setUsers([...users, {user, pass, role}]);
        setCurrent({user, role});
      };
      const login = (user, pass) => {
        const found = users.find(u => u.user===user && u.pass===pass);
        if(!found) return alert('Invalid credentials');
        setCurrent({user:found.user, role:found.role});
      };
      const logout = () => setCurrent(null);

      const addStudent = (name) => {
        if(!name || !name.trim()) return;
        setStudents([...students,{id:Date.now(),name,grade:2,points:0,detention:false}]);
      };

      const markAttendance = (studentId,status) => {
        const today = new Date().toISOString().split('T')[0];
        const dayRec = attendance[today] || {};
        dayRec[studentId] = status;
        setAttendance({...attendance,[today]:dayRec});
      };

      const addBehaviour = (studentId, score, pointsDelta, note) => {
        const record = {id:Date.now(),studentId,score,pointsDelta,note,time:new Date().toISOString()};

        // Use functional update to ensure we compute counts from the newest logs
        setBehaviourLogs(prevLogs => {
          const newLogs = [record, ...prevLogs];

          // Update students based on the newLogs
          setStudents(prevStudents => {
            const updated = prevStudents.map(s => {
              if(s.id !== studentId) return s;
              const newPoints = (s.points || 0) + pointsDelta;
              // count '4' scores for this student using the new logs
              const fours = newLogs.filter(b => b.studentId === studentId && b.score === 4).length;
              const detentionNow = s.detention || (score === 2) || (newPoints <= -5) || (fours >= 2);
              return {...s, points: newPoints, detention: detentionNow};
            });

            const student = updated.find(s => s.id === studentId);
            if(student && student.detention){
              try{ announce(`Detention issued to ${student.name}.`); }catch(e){}
            }

            return updated;
          });

          return newLogs;
        });
      };

      const recordGrade = (studentId, subject, grade) => {
        const rec = grades[studentId] || {};
        setGrades({...grades,[studentId]:{...rec,[subject]:grade}});
      };

      const updateLesson = (day, period, value) => {
        setTimetable({...timetable,[day]:{...timetable[day],[period]:value}});
      };

      const [paState, setPaState] = useState({fire:false,lockdown:false,bell:false});
      const announce = (msg) => {
        if(!msg || !msg.trim()) return;
        try { const utter = new SpeechSynthesisUtterance(msg); speechSynthesis.speak(utter);}catch(e){alert('PA not supported');}
      };

      const triggerFire = () => {
        setPaState(s=>({...s,fire:true}));
        announce('Fire alarm triggered. Evacuate the building immediately.');
        setTimeout(()=>setPaState(s=>({...s,fire:false})),20000);
      };
      const triggerLockdown = () => {
        setPaState(s=>({...s,lockdown:true}));
        announce('Lockdown initiated. Move to secure location and wait for further instructions.');
        setTimeout(()=>setPaState(s=>({...s,lockdown:false})),20000);
      };
      const triggerBell = () => {
        setPaState(s=>({...s,bell:true}));
        announce('School bell ringing.');
        setTimeout(()=>setPaState(s=>({...s,bell:false})),5000);
      };

      const pages = ['Dashboard','Students','Attendance','Behaviour','Timetable','Assessment','Reports','PA'];
      const [activePage, setActivePage] = useState('Dashboard');

      // Helper: reset demo data and reload
      const resetDemo = () => {
        localStorage.clear();
        location.reload();
      };

      // Helper: run an in-app test that signs up and logs in a temporary user
      const runInAppTest = async () => {
        const testUser = 'qa_user_' + Date.now();
        const testPass = 'pass123';
        try{
          signup(testUser,testPass,'teacher');
        }catch(e){console.error(e); alert('Test failed during signup'); return}
        // wait briefly for React to update
        await new Promise(r=>setTimeout(r,250));
        // check for presence of sidebar element indicating successful login
        const ok = document.querySelector('.w-60') !== null || document.body.innerText.includes('AegisSchool');
        if(ok) alert('In-app test: LOGIN_OK (signed up and reached dashboard)');
        else alert('In-app test: LOGIN_FAILED (dashboard not reached)');
      };

      if(!current) return (
        <div className="p-6 max-w-md mx-auto space-y-4">
          <h1 className="text-2xl font-bold">AegisSchool MIS</h1>
          <input id="u" placeholder="Username" className="border p-2 w-full" />
          <input id="p" type="password" placeholder="Password" className="border p-2 w-full" />
          <button className="bg-blue-600 text-white p-2 w-full rounded" onClick={()=>login(document.getElementById('u').value,document.getElementById('p').value)}>Login</button>
          <h2 className="font-semibold">Signup</h2>
          <input id="su" placeholder="New user" className="border p-2 w-full" />
          <input id="sp" type="password" placeholder="Password" className="border p-2 w-full" />
          <select id="sr" className="border p-2 w-full">
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
          <button className="bg-green-600 text-white p-2 w-full rounded" onClick={()=>signup(document.getElementById('su').value,document.getElementById('sp').value,document.getElementById('sr').value)}>Create Account</button>
          <div className="flex gap-2 mt-2">
            <button className="flex-1 bg-yellow-500 text-black p-2 rounded" onClick={resetDemo}>Reset demo data</button>
            <button className="flex-1 bg-indigo-600 text-white p-2 rounded" onClick={runInAppTest}>Run in-app test</button>
          </div>
        </div>
      );

      const renderPage = () => {
        switch(activePage){
          case 'Students': return <StudentsPage students={students} addStudent={addStudent} />;
          case 'Attendance': return <AttendancePage students={students} attendance={attendance} markAttendance={markAttendance}/>;
          case 'Behaviour': return <BehaviourPage students={students} behaviourLogs={behaviourLogs} addBehaviour={addBehaviour}/>;
          case 'Timetable': return <TimetablePage timetable={timetable} updateLesson={updateLesson}/>;
          case 'Assessment': return <AssessmentPage students={students} grades={grades} recordGrade={recordGrade}/>;
          case 'Reports': return <ReportsPage students={students} attendance={attendance} behaviourLogs={behaviourLogs}/>;
          case 'PA': return <PApage announce={announce} paState={paState} triggerFire={triggerFire} triggerLockdown={triggerLockdown} triggerBell={triggerBell}/>;
          default: return <DashboardPage/>;
        }
      };

      return (
        <div className="flex h-full">
          <div className="w-60 bg-blue-700 text-white h-full p-4 flex flex-col gap-2">
            <div className="flex items-center gap-2">
              <h1 className="text-2xl font-bold mb-4">AegisSchool</h1>
              {(() => {
                const assistantStudent = students.find(s => s.name === 'GitHub Copilot');
                const hasDetention = assistantStudent ? assistantStudent.detention : false;
                return (
                  <span className={`text-xs px-2 py-1 rounded ${hasDetention ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-800'}`}>
                    GitHub Copilot
                  </span>
                );
              })()}
            </div>
            {pages.map(p=><button key={p} className={`p-2 rounded ${activePage===p?'bg-blue-900':'bg-blue-600 hover:bg-blue-800'}`} onClick={()=>setActivePage(p)}>{p}</button>)}
            <button className="mt-auto bg-red-600 p-2 rounded" onClick={logout}>Logout</button>
          </div>
          <div className="flex-1 p-6 bg-gray-100 min-h-screen">
            {paState.fire && <div className="bg-red-600 text-white p-3 rounded mb-4 font-semibold">FIRE ALARM — Evacuate the building immediately</div>}
            {paState.lockdown && <div className="bg-purple-700 text-white p-3 rounded mb-4 font-semibold">LOCKDOWN — Secure in place and await instructions</div>}
            {paState.bell && <div className="bg-yellow-300 text-black p-3 rounded mb-4 font-semibold">SCHOOL BELL — Period change</div>}
            {renderPage()}
          </div>
        </div>
      );
    }

    const DashboardPage = ()=> <div className="text-2xl font-bold">Welcome to AegisSchool MIS Dashboard</div>;
    const StudentsPage = ({students, addStudent}) => {
      const [input,setInput]=useState('');
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Students</h2>
          <div className="flex gap-2 mb-2">
            <input className="border p-2 flex-1" value={input} onChange={e=>setInput(e.target.value)} placeholder="Add student"/>
            <button className="bg-blue-600 text-white px-3 py-2 rounded" onClick={()=>{addStudent(input); setInput('');}}>Add</button>
          </div>
          <ul className="bg-white p-2 rounded shadow">
            {students.map(s=>
              <li key={s.id} className="p-2 border-b flex items-center justify-between">
                <div>
                  <div className="font-semibold">{s.name}</div>
                  <div className="text-sm text-gray-600">Grade: {s.grade} · Points: {s.points || 0}</div>
                </div>
                <div className="flex items-center gap-2">
                  {s.detention && <span className="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Detention</span>}
                </div>
              </li>
            )}
          </ul>
        </div>
      );
    };
    const AttendancePage = ({students,attendance,markAttendance}) => {
      const today=new Date().toISOString().split('T')[0];
      const todayRec=attendance[today]||{};
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Attendance</h2>
          {students.map(s=><div key={s.id} className="flex gap-2 items-center mb-1">
            <span className="w-48">{s.name}</span>
            {['present','late','absent'].map(status=><button key={status} className={`px-2 py-1 rounded ${todayRec[s.id]===status?'bg-green-500 text-white':'bg-gray-200'}`} onClick={()=>markAttendance(s.id,status)}>{status[0].toUpperCase()}</button>)}
          </div>)}
        </div>
      );
    };
    const BehaviourPage = ({students,behaviourLogs,addBehaviour}) => {
      const [studentId,setStudentId]=useState('');
      const [score,setScore]=useState(3);
      const [points,setPoints]=useState(0);
      const [note,setNote]=useState('');
      const runDetentionTest = async () => {
        if(!studentId) return alert('Select student first');
        // add two '4' records quickly
        addBehaviour(Number(studentId),4,0,'Auto detention test 1');
        await new Promise(r=>setTimeout(r,200));
        addBehaviour(Number(studentId),4,0,'Auto detention test 2');
      };
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Behaviour</h2>
          <div className="flex gap-2 items-center mb-2">
            <select value={studentId} onChange={e=>setStudentId(e.target.value)} className="border p-2">
              <option value="">Select student</option>
              {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
            </select>
            <select value={score} onChange={e=>setScore(Number(e.target.value))} className="border p-2">
              <option value={1}>1 Excellent</option>
              <option value={2}>2 Good</option>
              <option value={3}>3 Disruptive</option>
              <option value={4}>4 Poor</option>
              <option value={5}>5 Unsatisfactory</option>
            </select>
            <input type="number" value={points} onChange={e=>setPoints(Number(e.target.value))} placeholder="Points" className="border p-2"/>
            <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Note" className="border p-2"/>
            <button className="bg-blue-600 text-white px-3 py-2" onClick={()=>{if(!studentId) return; addBehaviour(Number(studentId),score,points,note); setNote(''); setPoints(0);}}>Add</button>
            <button className="bg-red-500 text-white px-3 py-2 ml-2" onClick={runDetentionTest}>Detention flow test</button>
          </div>
          <ul className="mt-2 bg-white p-2 rounded shadow max-h-60 overflow-auto">
            {behaviourLogs.map(b=><li key={b.id}>{students.find(s=>s.id===b.studentId)?.name || 'Unknown'} - Score: {b.score} - Points: {b.pointsDelta} - {b.note}</li>)}
          </ul>
        </div>
      );
    };
    const TimetablePage = ({timetable,updateLesson}) => {
      const days=['Monday','Tuesday','Wednesday','Thursday','Friday'];
      const periods=['P1','P2','P3','P4','P5'];
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Timetable Editor</h2>
          {days.map(day=><div key={day} className="mb-2">
            <h3 className="font-semibold">{day}</h3>
            <div className="grid grid-cols-5 gap-2">
              {periods.map(p=><input key={p} className="border p-2" value={timetable[day][p]} onChange={e=>updateLesson(day,p,e.target.value)} placeholder={p}/>) }
            </div>
          </div>)}
        </div>
      );
    };
    const AssessmentPage = ({students,grades,recordGrade}) => {
      const [studentId,setStudentId]=useState('');
      const [subject,setSubject]=useState('Math');
      const [mark,setMark]=useState('');
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Assessment</h2>
          <div className="flex gap-2 items-center">
            <select value={studentId} onChange={e=>setStudentId(e.target.value)} className="border p-2">
              <option value="">Select student</option>
              {students.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
            </select>
            <input value={subject} onChange={e=>setSubject(e.target.value)} placeholder="Subject" className="border p-2"/>
            <input value={mark} onChange={e=>setMark(e.target.value)} placeholder="Mark" className="border p-2"/>
            <button className="bg-green-600 text-white px-3 py-2" onClick={()=>{if(!studentId) return; recordGrade(Number(studentId),subject,mark); setMark('');}}>Save</button>
          </div>
        </div>
      );
    };
    const ReportsPage = ({students,attendance,behaviourLogs}) => {
      const exportCSV=(rows,filename)=>{
        const csv=rows.map(r=>r.join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);
      };
      const exportAttendance=()=>{
        const rows=[['Date','Student','Status']];
        Object.entries(attendance).forEach(([date,dayRec])=>{
          students.forEach(s=>rows.push([date,s.name,dayRec[s.id]||'absent']));
        });
        exportCSV(rows,'attendance.csv');
      };
      const exportBehaviour=()=>{
        const rows=[['Student','Score','Points','Note','Time']];
        behaviourLogs.forEach(b=>{
          const name=students.find(s=>s.id===b.studentId)?.name||b.studentId;
          rows.push([name,b.score,b.pointsDelta||0,b.note,b.time]);
        });
        exportCSV(rows,'behaviour.csv');
      };
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">Reports</h2>
          <button className="bg-blue-600 text-white px-3 py-2 mr-2" onClick={exportAttendance}>Export Attendance</button>
          <button className="bg-indigo-600 text-white px-3 py-2" onClick={exportBehaviour}>Export Behaviour</button>
        </div>
      );
    };
    const PApage = ({announce, paState, triggerFire, triggerLockdown, triggerBell}) => {
      const [msg,setMsg]=useState('');
      return (
        <div>
          <h2 className="text-xl font-bold mb-2">PA System</h2>
          <div className="flex gap-2 mb-3">
            <button className="bg-red-600 text-white px-3 py-2 rounded flex-1" onClick={triggerFire}>Fire Alarm</button>
            <button className="bg-purple-700 text-white px-3 py-2 rounded flex-1" onClick={triggerLockdown}>Lockdown</button>
            <button className="bg-yellow-300 text-black px-3 py-2 rounded flex-1" onClick={triggerBell}>School Bell</button>
          </div>
          <div className="flex gap-2 items-center mb-3">
            <div className={`px-2 py-1 rounded ${paState.fire? 'bg-red-600 text-white':'bg-gray-200 text-gray-800'}`}>Fire: {paState.fire? 'ACTIVE':'idle'}</div>
            <div className={`px-2 py-1 rounded ${paState.lockdown? 'bg-purple-700 text-white':'bg-gray-200 text-gray-800'}`}>Lockdown: {paState.lockdown? 'ACTIVE':'idle'}</div>
            <div className={`px-2 py-1 rounded ${paState.bell? 'bg-yellow-300 text-black':'bg-gray-200 text-gray-800'}`}>Bell: {paState.bell? 'RINGING':'idle'}</div>
          </div>
          <textarea className="border p-2 w-full" value={msg} onChange={e=>setMsg(e.target.value)} placeholder="Type announcement"></textarea>
          <button className="bg-purple-600 text-white px-3 py-2 mt-2" onClick={()=>{announce(msg); setMsg('');}}>Announce</button>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AegisSchoolMIS />);
  </script>
</body>
</html>
